<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INFRASTRUCT | Topology Design | Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
            overflow: hidden;
        }
        
        canvas {
            cursor: crosshair;
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .panel {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .tool-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Modal Styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(4px);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        .modal-backdrop.active { display: flex; }
        .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            width: 600px;
            max-width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 8px;
            animation: modalPop 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes modalPop {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Pattern Generation for Tunnel/Ground */
        .pattern-soil {
            background-color: #3f2e26;
            background-image: repeating-linear-gradient(45deg, #4a3b32 25%, transparent 25%, transparent 75%, #4a3b32 75%, #4a3b32), repeating-linear-gradient(45deg, #4a3b32 25%, #3f2e26 25%, #3f2e26 75%, #4a3b32 75%, #4a3b32);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- Header -->
    <header class="h-14 border-b border-slate-700 bg-slate-900 flex items-center justify-between px-4 shrink-0 z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-bold text-white tracking-tighter">
                IS
            </div>
            <div>
                <h1 class="text-sm font-bold tracking-wide text-white">INFRASTRUCT</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest">Topology Design & Analysis</p>
            </div>
        </div>

        <!-- Mode Selector -->
        <div class="flex bg-slate-800 rounded p-1 gap-1">
            <button onclick="setMode('bridge')" id="mode-bridge" class="px-3 py-1 text-[10px] font-bold rounded bg-slate-700 text-white transition">BRIDGE</button>
            <button onclick="setMode('tunnel')" id="mode-tunnel" class="px-3 py-1 text-[10px] font-bold rounded hover:bg-slate-700 text-slate-400 transition">TUNNEL</button>
            <button onclick="setMode('highway')" id="mode-highway" class="px-3 py-1 text-[10px] font-bold rounded hover:bg-slate-700 text-slate-400 transition">HIGHWAY</button>
        </div>
        
        <div class="flex items-center gap-4">
            <div id="status-indicator" class="flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                SYSTEM STABLE
            </div>
            <button onclick="toggleModal()" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded border border-slate-600 transition" title="Technical Manifest">
                <i class="fas fa-info-circle"></i> Info
            </button>
            <button onclick="resetModel()" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded border border-slate-600 transition">
                Reset
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Left Sidebar: Tools -->
        <aside class="w-16 bg-slate-800 border-r border-slate-700 flex flex-col items-center py-4 gap-4 z-10 shrink-0">
            <div class="flex flex-col gap-2 w-full px-2">
                <button onclick="setTool('select')" id="btn-select" class="tool-btn active w-full aspect-square rounded flex flex-col items-center justify-center gap-1 text-slate-400 hover:text-white hover:bg-slate-700 transition" title="Select / Move">
                    <i class="fas fa-mouse-pointer"></i>
                    <span class="text-[9px]">EDIT</span>
                </button>
                <button onclick="setTool('load')" id="btn-load" class="tool-btn w-full aspect-square rounded flex flex-col items-center justify-center gap-1 text-slate-400 hover:text-white hover:bg-slate-700 transition" title="Add Point Load">
                    <i class="fas fa-arrow-down"></i>
                    <span class="text-[9px]">LOAD</span>
                </button>
                <button onclick="setTool('support')" id="btn-support" class="tool-btn w-full aspect-square rounded flex flex-col items-center justify-center gap-1 text-slate-400 hover:text-white hover:bg-slate-700 transition" title="Add Support">
                    <i class="fas fa-caret-up"></i>
                    <span class="text-[9px]">PIER</span>
                </button>
            </div>
            
            <div class="mt-auto flex flex-col gap-2 w-full px-2">
                 <button onclick="toggleDiagrams()" class="w-full aspect-square rounded flex flex-col items-center justify-center gap-1 text-slate-400 hover:text-white hover:bg-slate-700 transition border border-slate-600" title="Toggle Diagrams">
                    <i class="fas fa-chart-area"></i>
                    <span class="text-[9px]">DIAG</span>
                </button>
            </div>
        </aside>

        <!-- Center: Canvas -->
        <main class="flex-1 relative bg-slate-900 overflow-hidden">
            <canvas id="mainCanvas" class="w-full h-full block"></canvas>
            
            <!-- Overlay Info -->
            <div class="absolute bottom-4 left-4 pointer-events-none">
                <div class="text-[10px] text-slate-500 font-mono">
                    GRID: 1m | SCALE: 1:100<br>
                    SOLVER: FEM (Stiffness Matrix 1D + UDL)
                </div>
            </div>
        </main>

        <!-- Right Sidebar: Properties & Data -->
        <aside class="w-80 bg-slate-900 border-l border-slate-700 flex flex-col shrink-0 overflow-y-auto z-10">
            
            <!-- Contextual Properties -->
            <div class="p-4 border-b border-slate-700">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Item Properties</h2>
                <div id="properties-panel">
                    <p class="text-sm text-slate-500 italic">Select an element to edit properties.</p>
                </div>
            </div>

            <!-- Section / Geology Calculator -->
            <div class="p-4 border-b border-slate-700 bg-slate-800/30">
                <h2 class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-3 flex items-center justify-between">
                    <span>Section Calculator</span>
                    <i class="fas fa-calculator text-slate-500"></i>
                </h2>
                <div class="space-y-3" id="calc-panel">
                    <!-- Dynamic Calc Content based on Mode -->
                </div>
            </div>

            <!-- Survey / Geotech Data -->
            <div class="p-4 border-b border-slate-700">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Survey & Limits</h2>
                <div class="space-y-3">
                    <div>
                        <label class="text-[11px] text-slate-400 block mb-1">Soil Bearing Capacity (kN/m²)</label>
                        <input type="number" id="soil-bearing" value="200" onchange="updateSystemParams()" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label class="text-[11px] text-slate-400 block mb-1">Beam Stiffness (EI)</label>
                        <input type="number" id="beam-ei" value="20000" onchange="updateSystemParams()" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-blue-500 transition">
                    </div>
                </div>
            </div>

            <!-- Analysis Results -->
            <div class="p-4 flex-1">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Live Analysis</h2>
                <div id="analysis-results" class="space-y-2">
                    <!-- Dynamic Results populated by JS -->
                </div>
                
                <div id="error-log" class="mt-6 p-3 bg-red-900/20 border border-red-500/30 rounded hidden">
                    <h3 class="text-red-400 text-xs font-bold mb-1"><i class="fas fa-exclamation-triangle mr-1"></i> DESIGN ALERTS</h3>
                    <ul id="error-list" class="text-[10px] text-red-300 space-y-1 list-disc pl-3"></ul>
                </div>
            </div>
        </aside>
    </div>

    <!-- Technical Manifest Modal -->
    <div id="techModal" class="modal-backdrop active" onclick="if(event.target === this) toggleModal()">
        <div class="modal-content p-6">
            <div class="flex justify-between items-start mb-4 border-b border-slate-700 pb-4">
                <div>
                    <h2 class="text-lg font-bold text-white tracking-wide">INFRASTRUCT <span class="text-slate-500 font-normal">| Technical Manifest</span></h2>
                    <p class="text-[10px] text-blue-400 font-mono mt-1 uppercase tracking-wider">v2.0.1 | Multi-Mode Design Engine</p>
                </div>
                <button onclick="toggleModal()" class="text-slate-400 hover:text-white transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-5 text-sm text-slate-300">
                <section>
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2"><i class="fas fa-layer-group"></i> Design Modes</h3>
                    <div class="grid grid-cols-3 gap-2 text-center text-[10px]">
                        <div class="bg-slate-800 p-2 rounded border border-slate-700">
                            <i class="fas fa-archway text-lg text-blue-400 mb-1"></i>
                            <div class="font-bold text-slate-200">BRIDGE</div>
                            <div class="text-slate-500">Continuous Span</div>
                        </div>
                        <div class="bg-slate-800 p-2 rounded border border-slate-700">
                            <i class="fas fa-dungeon text-lg text-amber-600 mb-1"></i>
                            <div class="font-bold text-slate-200">TUNNEL</div>
                            <div class="text-slate-500">Roof Analysis</div>
                        </div>
                        <div class="bg-slate-800 p-2 rounded border border-slate-700">
                            <i class="fas fa-road text-lg text-emerald-500 mb-1"></i>
                            <div class="font-bold text-slate-200">HIGHWAY</div>
                            <div class="text-slate-500">Pavement Slab</div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2"><i class="fas fa-microchip"></i> Calculation Engine</h3>
                    <p class="mb-2 text-xs leading-relaxed text-slate-400">Uses a <strong>Matrix Stiffness Method</strong> enhanced for Uniformly Distributed Loads (UDL).</p>
                    <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                        <ul class="list-disc pl-4 space-y-1 text-slate-400 text-[10px]">
                            <li><strong>Point Loads:</strong> Modeled as nodal forces.</li>
                            <li><strong>Natural Weights (UDL):</strong> Modeled using Fixed End Moments (FEM).</li>
                            <li><strong>Eq:</strong> <code class="text-blue-400">w (kN/m) = Density (kN/m³) × Width × Depth</code></li>
                        </ul>
                    </div>
                </section>

                <div class="mt-4 pt-4 border-t border-slate-700 flex justify-end">
                    <button onclick="toggleModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded text-xs font-bold transition shadow-lg shadow-blue-500/20">Acknowledge & Begin</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- CONFIG & STATE ---
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        const GROUND_Y_OFFSET = 100; // Pixels from center
        const PIXELS_PER_METER = 40;
        
        let currentTool = 'select'; // select, load, support
        let currentMode = 'bridge'; // bridge, tunnel, highway
        let selectedObject = null;
        let isDragging = false;
        let showDiagrams = true;

        // Model Data
        let beamLength = 20; // meters
        let supports = [];   // { id, x (m), type: 'pin'|'roller' }
        let loads = [];      // { id, x (m), magnitude (kN), type: 'point' }
        
        // Distributed Load (Natural Weight / Geology)
        let distributedLoad = 0; // kN/m
        
        // Calculator Params (Preserved between modes)
        let calcParams = {
            bridge: { density: 24, area: 0.5 }, // Concrete 24kN/m3, 0.5m2 section
            tunnel: { density: 18, depth: 5 },  // Soil 18kN/m3, 5m deep
            highway: { density: 22, thickness: 0.3 } // Asphalt 22kN/m3, 30cm
        };
        
        // System Parameters
        let soilCapacity = 200; // kPa
        let footingArea = 1.0;  // m^2
        let EI = 20000;         // kNm^2
        let maxShearCapacity = 150; // kN

        // Analysis Results
        let reactions = {};
        let shearData = [];
        let momentData = [];
        let designErrors = [];

        // --- INITIALIZATION ---
        function init() {
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            resetModel();
            
            // Event Listeners
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('dblclick', handleDoubleClick);
            
            // Start Loop
            requestAnimationFrame(animate);
        }

        function setMode(mode) {
            currentMode = mode;
            // Visual Update
            ['bridge', 'tunnel', 'highway'].forEach(m => {
                const btn = document.getElementById(`mode-${m}`);
                if(m === mode) {
                    btn.className = "px-3 py-1 text-[10px] font-bold rounded bg-slate-700 text-white transition ring-1 ring-blue-500";
                } else {
                    btn.className = "px-3 py-1 text-[10px] font-bold rounded hover:bg-slate-700 text-slate-400 transition";
                }
            });
            
            // Recalculate based on default mode params
            updateCalculator();
            updateAnalysis();
        }

        function resetModel() {
            supports = [
                { id: generateId(), x: 2, type: 'pin' },
                { id: generateId(), x: 18, type: 'roller' }
            ];
            loads = [
                { id: generateId(), x: 10, magnitude: 50, type: 'point' }
            ];
            setMode(currentMode);
        }

        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            width = rect.width;
            height = rect.height;
            canvas.width = width;
            canvas.height = height;
            draw();
        }

        // --- SOLVER ENGINE (FEM + UDL) ---
        function updateAnalysis() {
            supports.sort((a, b) => a.x - b.x);
            
            // Nodes from supports and point loads
            let nodes = new Set([0, beamLength]);
            supports.forEach(s => nodes.add(s.x));
            loads.forEach(l => nodes.add(l.x));
            let sortedNodes = Array.from(nodes).sort((a, b) => a - b);
            
            const nNodes = sortedNodes.length;
            const nDof = nNodes * 2;
            let K = new Float64Array(nDof * nDof);
            let F = new Float64Array(nDof);
            
            // 1. Build Stiffness Matrix & 2. Apply UDL Fixed End Forces
            for (let i = 0; i < nNodes - 1; i++) {
                const start = sortedNodes[i];
                const end = sortedNodes[i+1];
                const L = end - start;
                
                if (L < 0.001) continue;
                
                // Element Stiffness
                const k = (EI) / (L * L * L);
                const k11=12*k, k12=6*k*L, k22=4*k*L*L, k23=-6*k*L, k24=2*k*L*L;
                
                // DOF Indices
                const i1 = i*2, i2 = i*2+1, i3 = (i+1)*2, i4 = (i+1)*2+1;
                
                addK(K, nDof, i1, i1, k11); addK(K, nDof, i1, i2, k12); addK(K, nDof, i1, i3, -k11); addK(K, nDof, i1, i4, k12);
                addK(K, nDof, i2, i1, k12); addK(K, nDof, i2, i2, k22); addK(K, nDof, i2, i3, k23); addK(K, nDof, i2, i4, k24);
                addK(K, nDof, i3, i1, -k11); addK(K, nDof, i3, i2, k23); addK(K, nDof, i3, i3, k11); addK(K, nDof, i3, i4, -k12);
                addK(K, nDof, i4, i1, k12); addK(K, nDof, i4, i2, k24); addK(K, nDof, i4, i3, -k12); addK(K, nDof, i4, i4, k22);

                // UDL Fixed End Forces (w*L^2/12 etc)
                // UDL acts DOWN (-y).
                // Force at nodes: -wL/2
                // Moment at nodes: -wL^2/12 (left), +wL^2/12 (right)
                if (distributedLoad !== 0) {
                    const w = distributedLoad;
                    const f_node = -w * L / 2;
                    const m_node = w * L * L / 12;
                    
                    F[i1] += f_node;
                    F[i2] += -m_node;
                    F[i3] += f_node;
                    F[i4] += m_node;
                }
            }

            // 3. Apply Point Loads
            loads.forEach(l => {
                const nodeIdx = sortedNodes.indexOf(l.x);
                if (nodeIdx !== -1) F[nodeIdx * 2] -= l.magnitude;
            });

            // 4. Boundary Conditions (Penalty Method)
            const penalty = 1e16;
            supports.forEach(s => {
                const nodeIdx = sortedNodes.indexOf(s.x);
                if (nodeIdx !== -1) K[(nodeIdx*2)*nDof + (nodeIdx*2)] += penalty;
            });

            // 5. Solve
            const displacements = solveLinearSystem(K, F, nDof);
            
            // 6. Compute Reactions & Diagrams
            reactions = {};
            // For simple reaction extraction in this method, we sum forces at node or use K*u.
            // Using Sum of Forces check is robust for simple visualizer.
            // Reaction R at support = ShearRight - ShearLeft (at support location)
            // But we need diagrams first.
            
            shearData = [];
            momentData = [];
            const segments = 200;
            const dx = beamLength / segments;

            // To get accurate reactions with UDL + Point Loads + Indeterminacy,
            // we use the calculated displacements to find element end forces, then sum.
            // Or simplified: We trust the FEA displacements and back-calculate element forces.
            // Element Force vector {f} = [k]{u} + {f_fixed_end}
            
            // Let's perform full scan for diagrams
            // We need a separate pass to determine Reactions from Stiffness.
            supports.forEach(s => {
                const nodeIdx = sortedNodes.indexOf(s.x);
                // Approx Reaction = Stiffness * Displacement (since we used Penalty)
                reactions[s.id] = -1 * displacements[nodeIdx*2] * penalty; 
            });

            for (let i = 0; i <= segments; i++) {
                const x = i * dx;
                let V = 0;
                let M = 0;
                
                // Supports (Upward)
                supports.forEach(s => {
                    if (s.x <= x) {
                        let R = reactions[s.id]; 
                        V += R;
                        M += R * (x - s.x);
                    }
                });
                
                // Point Loads (Downward)
                loads.forEach(l => {
                    if (l.x <= x) {
                        V -= l.magnitude;
                        M -= l.magnitude * (x - l.x);
                    }
                });

                // Distributed Load (Downward)
                // Total load to left of x = w * x. Centroid at x/2.
                if (distributedLoad !== 0) {
                    const w = distributedLoad;
                    const loadTotal = w * x;
                    V -= loadTotal;
                    M -= loadTotal * (x/2); // Moment arm from x is x/2
                }

                shearData.push({x, v: V});
                momentData.push({x, m: M});
            }

            checkErrors();
        }

        function checkErrors() {
            designErrors = [];
            
            supports.forEach(s => {
                const R = reactions[s.id];
                const stress = Math.abs(R) / footingArea;
                if (stress > soilCapacity) {
                    designErrors.push(`Support at ${s.x.toFixed(1)}m: Bearing Failure (${stress.toFixed(0)} > ${soilCapacity} kPa)`);
                }
            });

            const maxV = Math.max(...shearData.map(d => Math.abs(d.v)));
            if (maxV > maxShearCapacity) {
                designErrors.push(`Shear Failure (${maxV.toFixed(0)} > ${maxShearCapacity} kN)`);
            }
            if (supports.length < 2) designErrors.push("Instability: Less than 2 supports.");
        }

        // --- MATH HELPERS ---
        function addK(K, N, r, c, val) { K[r * N + c] += val; }
        function solveLinearSystem(A, b, n) {
            for (let k = 0; k < n - 1; k++) {
                for (let i = k + 1; i < n; i++) {
                    const factor = A[i * n + k] / A[k * n + k];
                    for (let j = k; j < n; j++) {
                        A[i * n + j] -= factor * A[k * n + j];
                    }
                    b[i] -= factor * b[k];
                }
            }
            const x = new Float64Array(n);
            for (let i = n - 1; i >= 0; i--) {
                let sum = b[i];
                for (let j = i + 1; j < n; j++) {
                    sum -= A[i * n + j] * x[j];
                }
                x[i] = sum / A[i * n + i];
            }
            return x;
        }

        // --- UI & INTERACTION ---
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${tool}`).classList.add('active');
            canvas.style.cursor = tool === 'select' ? 'default' : 'crosshair';
            selectedObject = null;
            updateUI();
        }

        function updateCalculator() {
            const panel = document.getElementById('calc-panel');
            let content = '';
            
            if (currentMode === 'bridge') {
                content = `
                    <div class="text-[10px] text-slate-400 mb-1">Structure Self-Weight</div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="text-[9px] text-slate-500">Density (kN/m³)</label>
                            <input type="number" value="${calcParams.bridge.density}" onchange="calcParams.bridge.density=this.value; updateCalcLogic()" class="w-full bg-slate-900 border border-slate-700 rounded px-1 py-1 text-xs">
                        </div>
                        <div>
                            <label class="text-[9px] text-slate-500">Area (m²)</label>
                            <input type="number" value="${calcParams.bridge.area}" onchange="calcParams.bridge.area=this.value; updateCalcLogic()" class="w-full bg-slate-900 border border-slate-700 rounded px-1 py-1 text-xs">
                        </div>
                    </div>
                `;
            } else if (currentMode === 'tunnel') {
                content = `
                    <div class="text-[10px] text-slate-400 mb-1">Geology Overburden</div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="text-[9px] text-slate-500">Soil (kN/m³)</label>
                            <input type="number" value="${calcParams.tunnel.density}" onchange="calcParams.tunnel.density=this.value; updateCalcLogic()" class="w-full bg-slate-900 border border-slate-700 rounded px-1 py-1 text-xs">
                        </div>
                        <div>
                            <label class="text-[9px] text-slate-500">Depth (m)</label>
                            <input type="number" value="${calcParams.tunnel.depth}" onchange="calcParams.tunnel.depth=this.value; updateCalcLogic()" class="w-full bg-slate-900 border border-slate-700 rounded px-1 py-1 text-xs">
                        </div>
                    </div>
                `;
            } else if (currentMode === 'highway') {
                content = `
                    <div class="text-[10px] text-slate-400 mb-1">Pavement Section</div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="text-[9px] text-slate-500">Mat (kN/m³)</label>
                            <input type="number" value="${calcParams.highway.density}" onchange="calcParams.highway.density=this.value; updateCalcLogic()" class="w-full bg-slate-900 border border-slate-700 rounded px-1 py-1 text-xs">
                        </div>
                        <div>
                            <label class="text-[9px] text-slate-500">Thick (m)</label>
                            <input type="number" value="${calcParams.highway.thickness}" onchange="calcParams.highway.thickness=this.value; updateCalcLogic()" class="w-full bg-slate-900 border border-slate-700 rounded px-1 py-1 text-xs">
                        </div>
                    </div>
                `;
            }

            content += `
                <div class="flex items-center justify-between bg-slate-900 p-2 rounded border border-slate-700">
                    <span class="text-[10px] text-slate-400">Result Load</span>
                    <span class="text-xs font-mono font-bold text-blue-400" id="calc-result">0 kN/m</span>
                </div>
            `;
            panel.innerHTML = content;
            updateCalcLogic();
        }

        function updateCalcLogic() {
            let val = 0;
            if (currentMode === 'bridge') val = calcParams.bridge.density * calcParams.bridge.area;
            if (currentMode === 'tunnel') val = calcParams.tunnel.density * calcParams.tunnel.depth; // 1m width strip
            if (currentMode === 'highway') val = calcParams.highway.density * calcParams.highway.thickness; // 1m width strip
            
            distributedLoad = val;
            document.getElementById('calc-result').innerText = val.toFixed(1) + " kN/m";
            updateAnalysis();
            updateUI();
        }

        function updateUI() {
            // Contextual Logic for Props Panel
            const panel = document.getElementById('properties-panel');
            if (selectedObject) {
                 if (selectedObject.type === 'load') {
                    panel.innerHTML = `
                        <div class="space-y-2">
                            <div class="text-[10px] text-blue-400 font-bold">POINT LOAD SELECTED</div>
                            <div>
                                <label class="text-[10px] text-slate-400">Position (m)</label>
                                <input type="number" step="0.5" value="${selectedObject.obj.x}" onchange="updateLoadProp(this.value, 'x')" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs text-white">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400">Magnitude (kN)</label>
                                <input type="number" step="10" value="${selectedObject.obj.magnitude}" onchange="updateLoadProp(this.value, 'mag')" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs text-white">
                            </div>
                            <button onclick="deleteSelected()" class="w-full bg-red-900/30 text-red-400 border border-red-900/50 rounded py-1 text-xs hover:bg-red-900/50 mt-2">Delete Load</button>
                        </div>`;
                } else if (selectedObject.type === 'support') {
                     panel.innerHTML = `
                        <div class="space-y-2">
                            <div class="text-[10px] text-blue-400 font-bold">SUPPORT SELECTED</div>
                            <div>
                                <label class="text-[10px] text-slate-400">Position (m)</label>
                                <input type="number" step="0.5" value="${selectedObject.obj.x}" onchange="updateSupportProp(this.value)" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs text-white">
                            </div>
                            <div class="text-[10px] text-slate-500 mt-2">Reaction: <span class="text-white mono">${(reactions[selectedObject.obj.id] || 0).toFixed(2)} kN</span></div>
                            <button onclick="deleteSelected()" class="w-full bg-red-900/30 text-red-400 border border-red-900/50 rounded py-1 text-xs hover:bg-red-900/50 mt-2">Remove Pier</button>
                        </div>`;
                }
            } else {
                panel.innerHTML = `<p class="text-sm text-slate-500 italic">Select an element to edit properties.</p>`;
            }

            // Results
            let maxM = momentData.length ? Math.max(...momentData.map(d => Math.abs(d.m))) : 0;
            let maxV = shearData.length ? Math.max(...shearData.map(d => Math.abs(d.v))) : 0;
            const analysisPanel = document.getElementById('analysis-results');
            
            analysisPanel.innerHTML = `
                <div class="grid grid-cols-2 gap-2 text-xs mb-3">
                    <div class="bg-slate-800 p-2 rounded">
                        <div class="text-slate-400 text-[10px]">MAX MOMENT</div>
                        <div class="text-blue-400 font-mono">${maxM.toFixed(1)} kNm</div>
                    </div>
                    <div class="bg-slate-800 p-2 rounded">
                        <div class="text-slate-400 text-[10px]">MAX SHEAR</div>
                        <div class="${maxV > maxShearCapacity ? 'text-red-400' : 'text-emerald-400'} font-mono">${maxV.toFixed(1)} kN</div>
                    </div>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] border-b border-slate-800 pb-1">
                        <span class="text-slate-500">Supports / Piers</span>
                        <span class="text-slate-300">${supports.length}</span>
                    </div>
                     <div class="flex justify-between text-[11px] border-b border-slate-800 pb-1">
                        <span class="text-slate-500">Point Loads</span>
                        <span class="text-slate-300">${loads.reduce((a,b)=>a+b.magnitude,0)} kN</span>
                    </div>
                    <div class="flex justify-between text-[11px] border-b border-slate-800 pb-1">
                        <span class="text-slate-500">Nat. Weight (UDL)</span>
                        <span class="text-slate-300">${(distributedLoad * beamLength).toFixed(0)} kN</span>
                    </div>
                </div>
            `;
            
            // Errors
            const errorPanel = document.getElementById('error-log');
            const errorList = document.getElementById('error-list');
            const statusInd = document.getElementById('status-indicator');
             if (designErrors.length > 0) {
                errorPanel.classList.remove('hidden');
                errorList.innerHTML = designErrors.map(e => `<li>${e}</li>`).join('');
                statusInd.className = "flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-red-500/10 text-red-400 border border-red-500/20";
                statusInd.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> CRITICAL`;
            } else {
                errorPanel.classList.add('hidden');
                statusInd.className = "flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-emerald-500/10 text-emerald-400 border border-emerald-500/20";
                statusInd.innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> SYSTEM STABLE`;
            }
        }

        // --- DRAWING ---
        function draw() {
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, width, height);
            
            const startX = (width - beamLength * PIXELS_PER_METER) / 2;
            const midY = height / 2;
            const beamY = midY + GROUND_Y_OFFSET;

            // DRAW CONTEXT BASED ON MODE
            if (currentMode === 'tunnel') {
                // Draw Ground Overburden (Hatch Pattern simulated)
                const depth = calcParams.tunnel.depth * PIXELS_PER_METER;
                ctx.fillStyle = '#1e1b18'; // Dark earth
                ctx.fillRect(0, 0, width, beamY);
                // Draw layers
                ctx.fillStyle = 'rgba(255,255,255,0.02)';
                for(let i=0; i<beamY; i+=20) ctx.fillRect(0, i, width, 1);
            } 
            else if (currentMode === 'highway') {
                // Draw Pavement layers below
                const thick = calcParams.highway.thickness * PIXELS_PER_METER * 10; // Exaggerate
                ctx.fillStyle = '#334155';
                ctx.fillRect(startX, beamY, beamLength * PIXELS_PER_METER, thick);
                ctx.fillStyle = '#475569'; // Base course
                ctx.fillRect(startX, beamY + thick, beamLength * PIXELS_PER_METER, thick);
                
                // Draw subgrade
                 ctx.fillStyle = '#0f172a';
                 // Grid visible below
            }

            // Standard Ground Line for Bridge
            if (currentMode === 'bridge') {
                ctx.beginPath();
                ctx.strokeStyle = '#334155';
                ctx.lineWidth = 1;
                ctx.moveTo(0, beamY + 50);
                ctx.lineTo(width, beamY + 50);
                ctx.stroke();
            }

            // Draw Beam
            ctx.fillStyle = '#64748b'; 
            if (currentMode === 'tunnel') ctx.fillStyle = '#78716c'; // Stone/Concrete color
            if (currentMode === 'highway') ctx.fillStyle = '#1e293b'; // Asphalt color
            
            ctx.fillRect(startX, beamY - 5, beamLength * PIXELS_PER_METER, 10);
            
            // Draw Distributed Load Arrows (if significant)
            if (distributedLoad > 1) {
                ctx.fillStyle = 'rgba(239, 68, 68, 0.3)';
                const loadH = Math.min(40, distributedLoad * 2);
                ctx.fillRect(startX, beamY - 5 - loadH, beamLength * PIXELS_PER_METER, loadH);
                // Arrows down
                ctx.fillStyle = 'rgba(239, 68, 68, 0.5)';
                for(let ix = 0; ix < beamLength; ix+=2) {
                     let lx = startX + ix * PIXELS_PER_METER;
                     ctx.beginPath();
                     ctx.moveTo(lx, beamY - 5 - loadH);
                     ctx.lineTo(lx, beamY - 5);
                     ctx.stroke();
                }
            }

            // Draw Supports
            supports.forEach(s => {
                const x = startX + s.x * PIXELS_PER_METER;
                const y = beamY + 5;
                ctx.fillStyle = '#94a3b8';
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x - 10, y + 15);
                ctx.lineTo(x + 10, y + 15);
                ctx.closePath();
                
                if (selectedObject && selectedObject.obj === s) ctx.fillStyle = '#3b82f6';
                ctx.fill();

                if (reactions[s.id] && (Math.abs(reactions[s.id])/footingArea > soilCapacity)) {
                    ctx.fillStyle = 'rgba(239, 68, 68, 0.4)';
                    ctx.beginPath(); ctx.arc(x, y + 20, 25, 0, Math.PI*2); ctx.fill();
                }
            });

            // Draw Loads (Point)
            loads.forEach(l => {
                const x = startX + l.x * PIXELS_PER_METER;
                const y = beamY - 5;
                const arrowHeight = 40;
                ctx.strokeStyle = '#ef4444'; ctx.fillStyle = '#ef4444'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(x, y - arrowHeight); ctx.lineTo(x, y); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x - 5, y - 10); ctx.lineTo(x, y); ctx.lineTo(x + 5, y - 10); ctx.fill();
                ctx.fillStyle = '#f87171'; ctx.font = '10px Inter'; ctx.textAlign = 'center';
                ctx.fillText(`${l.magnitude}kN`, x, y - arrowHeight - 5);
                if (selectedObject && selectedObject.obj === l) {
                    ctx.beginPath(); ctx.arc(x, y - arrowHeight, 4, 0, Math.PI*2); ctx.fillStyle = '#3b82f6'; ctx.fill();
                }
            });

            // Diagrams
            if (showDiagrams && shearData.length > 0) {
                // SFD
                const sfdScale = 0.5;
                const sfdY = midY - 80;
                ctx.beginPath(); ctx.moveTo(startX, sfdY);
                shearData.forEach(pt => ctx.lineTo(startX + pt.x * PIXELS_PER_METER, sfdY - pt.v * sfdScale));
                ctx.lineTo(startX + beamLength * PIXELS_PER_METER, sfdY); ctx.closePath();
                ctx.fillStyle = 'rgba(16, 185, 129, 0.1)'; ctx.strokeStyle = 'rgba(16, 185, 129, 0.6)'; ctx.fill(); ctx.stroke();
                
                // BMD
                const bmdScale = 0.5;
                const bmdY = midY - 180;
                ctx.beginPath(); ctx.moveTo(startX, bmdY);
                momentData.forEach(pt => ctx.lineTo(startX + pt.x * PIXELS_PER_METER, bmdY - pt.m * bmdScale));
                ctx.lineTo(startX + beamLength * PIXELS_PER_METER, bmdY); ctx.closePath();
                ctx.fillStyle = 'rgba(59, 130, 246, 0.1)'; ctx.strokeStyle = 'rgba(59, 130, 246, 0.6)'; ctx.fill(); ctx.stroke();
            }
        }
        
        // Interaction Handlers (Mouse Down/Move/Up/DblClick) - Identical to previous version but calling updateAnalysis()
        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const startX = (width - beamLength * PIXELS_PER_METER) / 2;
            return {
                screenX: (evt.clientX - rect.left) * scaleX,
                screenY: (evt.clientY - rect.top) * scaleY,
                worldX: ((evt.clientX - rect.left) * scaleX - startX) / PIXELS_PER_METER
            };
        }

        function handleMouseDown(e) {
            const pos = getMousePos(e);
            if (currentTool === 'load') {
                if (pos.worldX >= 0 && pos.worldX <= beamLength) {
                    loads.push({ id: generateId(), x: Number(pos.worldX.toFixed(1)), magnitude: 50, type: 'point' });
                    updateAnalysis(); updateUI(); setTool('select');
                }
                return;
            }
            if (currentTool === 'support') {
                if (pos.worldX >= 0 && pos.worldX <= beamLength) {
                    supports.push({ id: generateId(), x: Number(pos.worldX.toFixed(1)), type: 'pin' });
                    updateAnalysis(); updateUI(); setTool('select');
                }
                return;
            }
            if (currentTool === 'select') {
                const startX = (width - beamLength * PIXELS_PER_METER) / 2;
                const beamY = height/2 + GROUND_Y_OFFSET;
                
                for (let l of loads) {
                    const lx = startX + l.x * PIXELS_PER_METER;
                    if (Math.abs(pos.screenX - lx) < 10 && pos.screenY < beamY) {
                        selectedObject = { type: 'load', obj: l }; isDragging = true; updateUI(); return;
                    }
                }
                for (let s of supports) {
                    const sx = startX + s.x * PIXELS_PER_METER;
                    if (Math.abs(pos.screenX - sx) < 15 && pos.screenY > beamY) {
                        selectedObject = { type: 'support', obj: s }; isDragging = true; updateUI(); return;
                    }
                }
                selectedObject = null; updateUI();
            }
        }
        function handleMouseMove(e) {
            if (!isDragging || !selectedObject) return;
            const pos = getMousePos(e);
            let newX = Math.max(0, Math.min(beamLength, pos.worldX));
            newX = Math.round(newX * 2) / 2;
            selectedObject.obj.x = newX;
            updateAnalysis();
        }
        function handleMouseUp() { isDragging = false; }
        function handleDoubleClick(e) {
             if (currentTool !== 'select') return;
            const pos = getMousePos(e);
            const startX = (width - beamLength * PIXELS_PER_METER) / 2;
            
            const loadIdx = loads.findIndex(l => Math.abs(pos.screenX - (startX + l.x * PIXELS_PER_METER)) < 15);
            if (loadIdx > -1) { loads.splice(loadIdx, 1); selectedObject = null; updateAnalysis(); updateUI(); return; }
            
            const suppIdx = supports.findIndex(s => Math.abs(pos.screenX - (startX + s.x * PIXELS_PER_METER)) < 15);
            if (suppIdx > -1) { supports.splice(suppIdx, 1); selectedObject = null; updateAnalysis(); updateUI(); return; }
        }

        // Helpers
        function updateLoadProp(v, p) { if(selectedObject?.type==='load') { if(p==='x') selectedObject.obj.x=parseFloat(v); if(p==='mag') selectedObject.obj.magnitude=parseFloat(v); updateAnalysis(); updateUI(); }}
        function updateSupportProp(v) { if(selectedObject?.type==='support') { selectedObject.obj.x=parseFloat(v); updateAnalysis(); updateUI(); }}
        function deleteSelected() { if(!selectedObject)return; if(selectedObject.type==='load') loads=loads.filter(l=>l!==selectedObject.obj); else supports=supports.filter(s=>s!==selectedObject.obj); selectedObject=null; updateAnalysis(); updateUI(); }
        function updateSystemParams() { soilCapacity = parseFloat(document.getElementById('soil-bearing').value); EI = parseFloat(document.getElementById('beam-ei').value); updateAnalysis(); updateUI(); }
        function toggleDiagrams() { showDiagrams = !showDiagrams; draw(); }
        function toggleModal() { document.getElementById('techModal').classList.toggle('active'); }
        function generateId() { return Math.random().toString(36).substr(2, 9); }
        function animate() { draw(); requestAnimationFrame(animate); }

        // Start
        init();

    </script>
</body>
</html>
